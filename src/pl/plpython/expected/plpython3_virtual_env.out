SELECT plpython3.create_virtual_env('venv') \gset
SET plpython3.virtual_env = :'create_virtual_env';
CREATE OR REPLACE FUNCTION test_path_added(virtual_env_name text) 
RETURNS TEXT AS $$
    import sys

    plpy.notice('PYTHON VIRTUAL ENV sys.prefix=' + str(sys.prefix))
    plpy.notice('PYTHON VIRTUAL ENV sys.exec_prefix=' + str(sys.exec_prefix))
    plpy.notice('PYTHON VIRTUAL ENV sys.executable=' + str(sys.executable))
    plpy.notice('PYTHON VIRTUAL ENV sys.base_prefix=' + str(sys.base_prefix))
    plpy.notice('PYTHON VIRTUAL ENV sys.base_exec_prefix=' + str(sys.base_exec_prefix))
    plpy.notice('PYTHON VIRTUAL ENV sys.base_executable=' + str(sys._base_executable))
    plpy.notice('PYTHON VIRTUAL ENV sys.home=' + str(sys._home))

    assert sys.prefix == f"/tmp/plpython3/{virtual_env_name}"
    assert sys.exec_prefix == f"/tmp/plpython3/{virtual_env_name}"
    assert sys.executable == f"/tmp/plpython3/{virtual_env_name}/bin/python"
    assert sys.base_prefix == f"/tmp/plpython3/{virtual_env_name}"
    assert sys.base_exec_prefix == f"/tmp/plpython3/{virtual_env_name}"
    assert sys._base_executable == f"/tmp/plpython3/{virtual_env_name}/bin/python"
    
    return "SUCCESS"
$$ language plpython3u;
WITH env AS (
  SELECT :'create_virtual_env' AS virtual_env_name
),
result AS (
  SELECT test_path_added(virtual_env_name) FROM env
  UNION ALL
  SELECT test_path_added(virtual_env_name) FROM gp_dist_random('gp_id'), env
)
SELECT DISTINCT * FROM result;
NOTICE:  PYTHON VIRTUAL ENV sys.prefix=/tmp/plpython3/venv_29ecb70833db4
NOTICE:  PYTHON VIRTUAL ENV sys.exec_prefix=/tmp/plpython3/venv_29ecb70833db4
NOTICE:  PYTHON VIRTUAL ENV sys.executable=/tmp/plpython3/venv_29ecb70833db4/bin/python
NOTICE:  PYTHON VIRTUAL ENV sys.base_prefix=/tmp/plpython3/venv_29ecb70833db4
NOTICE:  PYTHON VIRTUAL ENV sys.base_exec_prefix=/tmp/plpython3/venv_29ecb70833db4
NOTICE:  PYTHON VIRTUAL ENV sys.base_executable=/tmp/plpython3/venv_29ecb70833db4/bin/python
NOTICE:  PYTHON VIRTUAL ENV sys.home=/usr/bin
NOTICE:  PYTHON VIRTUAL ENV sys.prefix=/tmp/plpython3/venv_29ecb70833db4  (seg1 slice1 127.0.0.1:7003 pid=807138)
NOTICE:  PYTHON VIRTUAL ENV sys.exec_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg1 slice1 127.0.0.1:7003 pid=807138)
NOTICE:  PYTHON VIRTUAL ENV sys.executable=/tmp/plpython3/venv_29ecb70833db4/bin/python  (seg1 slice1 127.0.0.1:7003 pid=807138)
NOTICE:  PYTHON VIRTUAL ENV sys.base_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg1 slice1 127.0.0.1:7003 pid=807138)
NOTICE:  PYTHON VIRTUAL ENV sys.base_exec_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg1 slice1 127.0.0.1:7003 pid=807138)
NOTICE:  PYTHON VIRTUAL ENV sys.base_executable=/tmp/plpython3/venv_29ecb70833db4/bin/python  (seg1 slice1 127.0.0.1:7003 pid=807138)
NOTICE:  PYTHON VIRTUAL ENV sys.home=/usr/bin  (seg1 slice1 127.0.0.1:7003 pid=807138)
NOTICE:  PYTHON VIRTUAL ENV sys.prefix=/tmp/plpython3/venv_29ecb70833db4  (seg0 slice1 127.0.0.1:7002 pid=807136)
NOTICE:  PYTHON VIRTUAL ENV sys.exec_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg0 slice1 127.0.0.1:7002 pid=807136)
NOTICE:  PYTHON VIRTUAL ENV sys.executable=/tmp/plpython3/venv_29ecb70833db4/bin/python  (seg0 slice1 127.0.0.1:7002 pid=807136)
NOTICE:  PYTHON VIRTUAL ENV sys.base_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg0 slice1 127.0.0.1:7002 pid=807136)
NOTICE:  PYTHON VIRTUAL ENV sys.base_exec_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg0 slice1 127.0.0.1:7002 pid=807136)
NOTICE:  PYTHON VIRTUAL ENV sys.base_executable=/tmp/plpython3/venv_29ecb70833db4/bin/python  (seg0 slice1 127.0.0.1:7002 pid=807136)
NOTICE:  PYTHON VIRTUAL ENV sys.home=/usr/bin  (seg0 slice1 127.0.0.1:7002 pid=807136)
NOTICE:  PYTHON VIRTUAL ENV sys.prefix=/tmp/plpython3/venv_29ecb70833db4  (seg2 slice1 127.0.0.1:7004 pid=807137)
NOTICE:  PYTHON VIRTUAL ENV sys.exec_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg2 slice1 127.0.0.1:7004 pid=807137)
NOTICE:  PYTHON VIRTUAL ENV sys.executable=/tmp/plpython3/venv_29ecb70833db4/bin/python  (seg2 slice1 127.0.0.1:7004 pid=807137)
NOTICE:  PYTHON VIRTUAL ENV sys.base_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg2 slice1 127.0.0.1:7004 pid=807137)
NOTICE:  PYTHON VIRTUAL ENV sys.base_exec_prefix=/tmp/plpython3/venv_29ecb70833db4  (seg2 slice1 127.0.0.1:7004 pid=807137)
NOTICE:  PYTHON VIRTUAL ENV sys.base_executable=/tmp/plpython3/venv_29ecb70833db4/bin/python  (seg2 slice1 127.0.0.1:7004 pid=807137)
NOTICE:  PYTHON VIRTUAL ENV sys.home=/usr/bin  (seg2 slice1 127.0.0.1:7004 pid=807137)
 test_path_added 
-----------------
 SUCCESS
(1 row)

SET plpython3.virtual_env = :'create_virtual_env';
ERROR:  SET PYTHON Virtual Env failed, the GUC value can only be changed before initializing the python interpreter.
CREATE OR REPLACE FUNCTION test_import(name TEXT) 
RETURNS text AS $$
    import importlib
    ret = importlib.import_module(name)
    import re
    match = re.search(r"<module 'numpy' from '/tmp/plpython3/venv_", str(ret))
    if match:
        sub_string = match.group()
        return sub_string
    return ret

$$ language plpython3u;
SELECT DISTINCT * FROM
(
    SELECT test_import('numpy')
    UNION ALL
    SELECT test_import('numpy') from gp_dist_random('gp_id')
) t;
ERROR:  ModuleNotFoundError: No module named 'numpy'
CONTEXT:  Traceback (most recent call last):
  PL/Python function "test_import", line 3, in <module>
    ret = importlib.import_module(name)
  PL/Python function "test_import", line 126, in import_module
  PL/Python function "test_import", line 1029, in _gcd_import
  PL/Python function "test_import", line 1006, in _find_and_load
  PL/Python function "test_import", line 983, in _find_and_load_unlocked
PL/Python function "test_import"
CREATE OR REPLACE FUNCTION test_pip_install(name TEXT) 
RETURNS text AS $$
import contextlib
import importlib
import io
import pip

with contextlib.redirect_stdout(io.StringIO()) as stdout, contextlib.redirect_stderr(stdout):
    pip.main(['install', name])
    importlib.invalidate_caches()

return stdout.getvalue()
$$ language plpython3u;
SELECT DISTINCT * FROM
(
    SELECT test_pip_install('numpy')
    UNION ALL
    SELECT test_pip_install('numpy') from gp_dist_random('gp_id')
) t;
                                                      test_pip_install                                                      
----------------------------------------------------------------------------------------------------------------------------
 WARNING: pip is being invoked by an old script wrapper. This will fail in a future version of pip.                        +
 Please see https://github.com/pypa/pip/issues/5599 for advice on fixing the underlying issue.                             +
 To avoid this problem you can invoke Python with '-m pip' instead of running pip directly.                                +
 Collecting numpy                                                                                                          +
   Using cached numpy-1.24.3-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (17.3 MB)                            +
 Installing collected packages: numpy                                                                                      +
 Successfully installed numpy-1.24.3                                                                                       +
 WARNING: You are using pip version 20.2.4; however, version 23.1.2 is available.                                          +
 You should consider upgrading via the '/tmp/plpython3/venv_29ecb70833db4/bin/python -m pip install --upgrade pip' command.+
 
 WARNING: pip is being invoked by an old script wrapper. This will fail in a future version of pip.                        +
 Please see https://github.com/pypa/pip/issues/5599 for advice on fixing the underlying issue.                             +
 To avoid this problem you can invoke Python with '-m pip' instead of running pip directly.                                +
 Requirement already satisfied: numpy in /tmp/plpython3/venv_29ecb70833db4/lib/python3.9/site-packages (1.24.3)            +
 WARNING: You are using pip version 20.2.4; however, version 23.1.2 is available.                                          +
 You should consider upgrading via the '/tmp/plpython3/venv_29ecb70833db4/bin/python -m pip install --upgrade pip' command.+
 
(2 rows)

CREATE OR REPLACE FUNCTION test_pip_show(name TEXT) 
RETURNS text AS $$
import contextlib
import io
import pip

with contextlib.redirect_stdout(io.StringIO()) as stdout, contextlib.redirect_stderr(stdout):
    pip.main(['show', name])

return stdout.getvalue()
$$ language plpython3u;
SELECT DISTINCT * FROM
(
    SELECT test_pip_show('numpy')
    UNION ALL
    SELECT test_pip_show('numpy') from gp_dist_random('gp_id')
) t;
                                           test_pip_show                                            
----------------------------------------------------------------------------------------------------
 WARNING: pip is being invoked by an old script wrapper. This will fail in a future version of pip.+
 Please see https://github.com/pypa/pip/issues/5599 for advice on fixing the underlying issue.     +
 To avoid this problem you can invoke Python with '-m pip' instead of running pip directly.        +
 Name: numpy                                                                                       +
 Version: 1.24.3                                                                                   +
 Summary: Fundamental package for array computing in Python                                        +
 Home-page: https://www.numpy.org                                                                  +
 Author: Travis E. Oliphant et al.                                                                 +
 Author-email: None                                                                                +
 License: BSD-3-Clause                                                                             +
 Location: /tmp/plpython3/venv_29ecb70833db4/lib/python3.9/site-packages                           +
 Requires:                                                                                         +
 Required-by:                                                                                      +
 
 WARNING: pip is being invoked by an old script wrapper. This will fail in a future version of pip.+
 Please see https://github.com/pypa/pip/issues/5599 for advice on fixing the underlying issue.     +
 To avoid this problem you can invoke Python with '-m pip' instead of running pip directly.        +
 WARNING: Package(s) not found: numpy                                                              +
 
(2 rows)

SELECT DISTINCT * FROM
(
    SELECT test_import('numpy')
    UNION ALL
    SELECT test_import('numpy') from gp_dist_random('gp_id')
) t;
                test_import                 
--------------------------------------------
 <module 'numpy' from '/tmp/plpython3/venv_
(1 row)

